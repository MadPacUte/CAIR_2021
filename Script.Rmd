---
title: "CAIR 2021 - Building a Reproducible Equity Report in R"
author: "Randall"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load up necessary packages up front so that if you hand this code off to a
# coworker, it will fail at the beginning of the script.

# There are a few options you have to load up packages. The first is to use the function (library())

# library(tidyverse)
# library(janitor)

# There is another option that we reuse over and over.

# Create a logical check to see if the package *pacman* has been installed.
# If it has not been installed, then R will install it.

if (!require(pacman)) install.packages("pacman")

# Then using one of the functions (p_load()) within the package *pacman* we load the packages we want to use

pacman::p_load(tidyverse, lubridate, janitor, scales)

# Some of our favorite packages to use within data analysis, but are not using today:
# tidyverse, lubridate, readxl, janitor, plotly, reactable, DT, scales, tidygeocoder, here

# Set theme for better visualization
theme_set(theme_light())
```



```{r}
# Read in the first data set that will be used within the report
# We will use the function (read_csv()) from the package *readr*

data <-
  readr::read_csv("https://raw.githubusercontent.com/MadPacUte/CAIR_2021/main/CAIR_2021_Data.csv")

# Read in the second data set that will be used within the report
# We will use the function (read_csv()) from the package *readr*

data_2 <-
  readr::read_csv("https://raw.githubusercontent.com/MadPacUte/CAIR_2021/main/CAIR_2021_Data_2.csv")
```


```{r}
# Append the data together using the function (bind_rows()) from the package (dplyr)

data_raw <-
  data %>%
  dplyr::bind_rows(data_2)

# Do a quick check and ensure that the data was appended properly
# R is a great tool and has a lot of cool features, such as a calculator already built in

5998 + 6316

# Or you can use the function (nrow) for each dataset and add the two together

# nrow(data) + nrow(data_2)

# Double check that the two match
# (5998 + 6316) == nrow(data) + nrow(data_2)
```


```{r}
# After verifying you have all of the data within the completed dataset we can clean up the names of the columns
# We will do this by using the function (clean_names()) from the package *janitor*

data_clean <-
  data_raw %>%
  janitor::clean_names()

# The function (clean_names()) is great for cleaning up messy column names that are not structured very well

# Let's look at at the first 6 columns to compare what the column names looked like prior

data_raw %>%
  dplyr::select(1:6)

# This is what they transformed into

data_clean %>%
  dplyr::select(1:6)

# Much cleaner names, easier to read, and replaced capital letters with lowercase and _ to connect words
```


```{r}
# Now we will look at the column types using the function (glimpse()) from the package *dplyr*

data_clean %>%
  dplyr::glimpse()

# We can see that age is a dbl, hs_gpa is a chr.
# These data types are some of the most common ones
# Another common one is Date, which we would suggest looking into the package (lubridate)

# We can see that hs_gpa column is classified as a character, but we want to convert it to a factor

# We can convert the variable into a factor by using the function (mutate()) from the package *dplyr*

data_clean <-
  data_clean %>%
  dplyr::mutate(hs_gpa = factor(hs_gpa))

# We can now see that the hs_gpa column has now been reclassified as a factor

data_clean %>%
  dplyr::glimpse()

# Factors are classified by their ranking. Let's look at the levels of the hs_gpa column that we just converted
# into a factor is leveled.

levels(data_clean$hs_gpa)

# We can write out the levels by hand if we want them in a certain order. Let's assign an object to classify it correctly.

levels <-
  c("0.0-.4", "1.5-1.9", "2.0-2.4", "2.5-2.9", "3.0-3.4", "3.5-4.0", "> 4.0", "Unknown")

# We want to classify them into the correct order (lowest to highest) by using an argument from the function (factor())

data_clean <-
  data_clean %>%
  dplyr::mutate(hs_gpa = factor(hs_gpa, level = levels))

# Verify that they are now in the correct order.

levels(data_clean$hs_gpa)
```


```{r}

# We will create a summarized dataset by a few different categories that we are interested in exploring further
# We picked out age, hs_gpa, comp_sex, and ethnicity

data_summarized <-
  data_clean %>%
  group_by(age, hs_gpa, comp_sex, ethnicity) %>%
  summarize(total = n()) %>%
  ungroup() %>%
  mutate(age = as.character(age)) %>%
  tidyr::pivot_wider(names_from = comp_sex, values_from = total, values_fill = 0) %>%
  mutate(total = Male + Female + Unknown) %>%
  clean_names()
```






```{r}
# Let's do some basic graphs to explore the data.


# We can summarize the age column to understand the distribution and remove na values

age_summarized <-
  data_summarized %>%
  group_by(age) %>%
  summarize(
    male = sum(male),
    female = sum(female),
    unknown = sum(unknown),
    total = sum(total)
  ) %>%
  ungroup() %>%
  filter(!is.na(age))

# Plot the age category to see the distribution of ages

age_summarized %>%
  ggplot(aes(age, total)) +
  geom_col()


# Once we have the totals for each category, we can see if the distribution varies between male and female

age_summarized %>%
  pivot_longer(!age, names_to = "gender", values_to = "value") %>%
  filter(gender %in% c("male", "female")) %>%
  ggplot(aes(age, value, fill = gender)) +
  geom_col() +
  facet_wrap(~gender) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = comma) +
  labs(
    x = "Age",
    y = ""
  )
```


```{r}
# Sex gpa groupings

gpa_gender_summarized <-
  data_summarized %>%
  select(hs_gpa, male, female) %>%
  group_by(hs_gpa) %>%
  summarize(
    male = sum(male),
    female = sum(female)
  ) %>%
  filter(hs_gpa != "Unknown")


gpa_gender_summarized %>%
  gather(gender, value, !hs_gpa) %>%
  ggplot(aes(hs_gpa, value, fill = gender)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = comma) +
  labs(
    x = "HS GPA",
    y = "Count",
    fill = "Gender",
    title = "Distribution of HS GPA by gender"
  )
```



```{r}

# Ethnicity gpa and gender groupings

gpa_ethnicity_gender_summarized <-
  data_summarized %>%
  select(hs_gpa:female) %>%
  group_by(ethnicity, hs_gpa) %>%
  summarize(
    male = sum(male),
    female = sum(female)
  ) %>%
  ungroup() %>%
  filter(!is.na(ethnicity), ethnicity != "Unknown", hs_gpa != "Unknown")


gpa_ethnicity_gender_summarized %>%
  pivot_longer(cols = male:female, names_to = "gender", values_to = "count") %>%
  ggplot(aes(hs_gpa, count, fill = gender)) +
  geom_col(position = "dodge") +
  facet_wrap(~ethnicity, scales = "free_y") +
  scale_y_continuous(labels = comma) +
  labs(
    x = "HS GPA",
    y = "Count",
    fill = "Gender",
    title = "Distribution of HS GPA by Ethnicity and Gender",
    subtitle = "Scale of count is determined by each ethnicity to view distributions"
  )
```
